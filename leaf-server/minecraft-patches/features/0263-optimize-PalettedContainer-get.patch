From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hayanesuru <hayanesuru@outlook.jp>
Date: Sat, 9 Aug 2025 14:59:34 +0900
Subject: [PATCH] optimize PalettedContainer#get


diff --git a/net/minecraft/world/level/chunk/PalettedContainer.java b/net/minecraft/world/level/chunk/PalettedContainer.java
index 7c8f8772a6fba04dbafdb5dbf8098b6ebce6d6f2..07355d76cdb162b2d200c230e2511aca18babed3 100644
--- a/net/minecraft/world/level/chunk/PalettedContainer.java
+++ b/net/minecraft/world/level/chunk/PalettedContainer.java
@@ -29,6 +29,18 @@ public class PalettedContainer<T> implements PaletteResize<T>, PalettedContainer
     private final T @org.jetbrains.annotations.Nullable [] presetValues; // Paper - Anti-Xray - Add preset values
     //private final ThreadingDetector threadingDetector = new ThreadingDetector("PalettedContainer"); // Paper - unused
 
+    // Leaf start - optimize PalettedContainer#get
+    private static final java.lang.invoke.VarHandle DATA_HANDLE;
+    static {
+        try {
+            DATA_HANDLE = java.lang.invoke.MethodHandles.lookup()
+                .findVarHandle(PalettedContainer.class, "data", PalettedContainer.Data.class);
+        } catch (ReflectiveOperationException e) {
+            throw new ExceptionInInitializerError(e);
+        }
+    }
+    // Leaf end - optimize PalettedContainer#get
+
     public void acquire() {
         // this.threadingDetector.checkAndLock(); // Paper - disable this - use proper synchronization
     }
@@ -84,7 +96,7 @@ public class PalettedContainer<T> implements PaletteResize<T>, PalettedContainer
     }
 
     private T readPalette(final PalettedContainer.Data<T> data, final int paletteIdx) {
-        final T[] palette = ((ca.spottedleaf.moonrise.patches.fast_palette.FastPaletteData<T>)(Object)data).moonrise$getPalette();
+        final T[] palette = data.moonrise$getPalette(); // Leaf - optimize PalettedContainer#get - remove type cast
         if (palette == null) {
             return this.readPaletteSlow(data, paletteIdx);
         }
@@ -242,7 +254,7 @@ public class PalettedContainer<T> implements PaletteResize<T>, PalettedContainer
 
     public T get(int index) { // Paper - public
         // Paper start - optimise palette reads
-        final PalettedContainer.Data<T> data = this.data;
+        final PalettedContainer.Data<T> data = (PalettedContainer.Data<T>) DATA_HANDLE.getAcquire(this); // Leaf - optimize PalettedContainer#get
         return this.readPalette(data, data.storage.get(index));
         // Paper end - optimise palette reads
     }
