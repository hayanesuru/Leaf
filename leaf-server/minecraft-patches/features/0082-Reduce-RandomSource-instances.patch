From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Tue, 29 Nov 2022 00:45:45 +0100
Subject: [PATCH] Reduce RandomSource instances

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Gale - https://galemc.org

This patch is based on the following patch:
"don't create new random instance"
By: foss-mc <69294560+foss-mc@users.noreply.github.com>
As part of: Patina (https://github.com/PatinaMC/Patina)
Licensed under: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)

diff --git a/net/minecraft/server/commands/SpreadPlayersCommand.java b/net/minecraft/server/commands/SpreadPlayersCommand.java
index d96b5f4ea264b7c3bf20bf7fc253566fdf830fc8..cd8712aab9891d3a548b89cc746ac3e80536daf5 100644
--- a/net/minecraft/server/commands/SpreadPlayersCommand.java
+++ b/net/minecraft/server/commands/SpreadPlayersCommand.java
@@ -107,7 +107,7 @@ public class SpreadPlayersCommand {
         if (maxHeight < minY) {
             throw ERROR_INVALID_MAX_HEIGHT.create(maxHeight, minY);
         } else {
-            RandomSource randomSource = RandomSource.create();
+            RandomSource randomSource = source.getLevel().random; // Gale - Patina - reduce RandomSource instances
             double d = center.x - maxRange;
             double d1 = center.y - maxRange;
             double d2 = center.x + maxRange;
diff --git a/net/minecraft/server/rcon/thread/QueryThreadGs4.java b/net/minecraft/server/rcon/thread/QueryThreadGs4.java
index 7da5b7a7846ad6dc7b01cda064ed33c82da82679..60508dd1b9f17cb92be0edfbdce783f4bac1c134 100644
--- a/net/minecraft/server/rcon/thread/QueryThreadGs4.java
+++ b/net/minecraft/server/rcon/thread/QueryThreadGs4.java
@@ -340,7 +340,7 @@ public class QueryThreadGs4 extends GenericThread {
             this.identBytes[2] = data[5];
             this.identBytes[3] = data[6];
             this.ident = new String(this.identBytes, StandardCharsets.UTF_8);
-            this.challenge = RandomSource.create().nextInt(16777216);
+            this.challenge = java.util.concurrent.ThreadLocalRandom.current().nextInt(16777216); // Gale - Patina - reduce RandomSource instances
             this.challengeBytes = String.format(Locale.ROOT, "\t%s%d\u0000", this.ident, this.challenge).getBytes(StandardCharsets.UTF_8);
         }
 
diff --git a/net/minecraft/world/entity/projectile/FishingHook.java b/net/minecraft/world/entity/projectile/FishingHook.java
index 4a7abf4ae0c1f4c22c1c77d5ce9e67418b274365..470e4b40d55a9ae2f4c7cba6773529a06c038055 100644
--- a/net/minecraft/world/entity/projectile/FishingHook.java
+++ b/net/minecraft/world/entity/projectile/FishingHook.java
@@ -51,7 +51,7 @@ import org.slf4j.Logger;
 
 public class FishingHook extends Projectile {
     private static final Logger LOGGER = LogUtils.getLogger();
-    private final RandomSource syncronizedRandom = RandomSource.create();
+    private final RandomSource syncronizedRandom; // Gale - Patina - reduce RandomSource instances
     private boolean biting;
     public int outOfWaterTime;
     private static final int MAX_OUT_OF_WATER_TIME = 10;
@@ -89,6 +89,7 @@ public class FishingHook extends Projectile {
         this.minWaitTime = level.paperConfig().fishingTimeRange.minimum;
         this.maxWaitTime = level.paperConfig().fishingTimeRange.maximum;
         // Paper end - Configurable fishing time ranges
+        this.syncronizedRandom = level.random; // Gale - Patina - reduce RandomSource instances
     }
 
     public FishingHook(EntityType<? extends FishingHook> type, Level level) {
diff --git a/net/minecraft/world/entity/raid/Raid.java b/net/minecraft/world/entity/raid/Raid.java
index 018a1907c04df66c3c404b5f1bb15ff783858fdb..11e9163097dc1b51efcdec04b4db769ba00caa0b 100644
--- a/net/minecraft/world/entity/raid/Raid.java
+++ b/net/minecraft/world/entity/raid/Raid.java
@@ -122,7 +122,7 @@ public class Raid {
     public final ServerBossEvent raidEvent = new ServerBossEvent(RAID_NAME_COMPONENT, BossEvent.BossBarColor.RED, BossEvent.BossBarOverlay.NOTCHED_10);
     private int postRaidTicks;
     private int raidCooldownTicks;
-    private final RandomSource random = RandomSource.create();
+    //private final RandomSource random = RandomSource.create(); // Gale - Patina - reduce RandomSource instances
     public int numGroups;
     private Raid.RaidStatus status;
     private int celebrationTicks;
@@ -529,7 +529,7 @@ public class Raid {
         float f = 13.0F;
         int i = 64;
         Collection<ServerPlayer> players = this.raidEvent.getPlayers();
-        long randomLong = this.random.nextLong();
+        long randomLong = level.random.nextLong(); // Gale - Patina - reduce RandomSource instances
 
         for (ServerPlayer serverPlayer : level.players()) {
             Vec3 vec3 = serverPlayer.position();
@@ -553,7 +553,7 @@ public class Raid {
 
         for (Raid.RaiderType raiderType : Raid.RaiderType.VALUES) {
             int i1 = this.getDefaultNumSpawns(raiderType, i, shouldSpawnBonusGroup)
-                + this.getPotentialBonusSpawns(raiderType, this.random, i, currentDifficultyAt, shouldSpawnBonusGroup);
+                + this.getPotentialBonusSpawns(raiderType, level.random, i, currentDifficultyAt, shouldSpawnBonusGroup); // Gale - Patina - reduce RandomSource instances
             int i2 = 0;
 
             for (int i3 = 0; i3 < i1; i3++) {
diff --git a/net/minecraft/world/level/block/entity/TheEndGatewayBlockEntity.java b/net/minecraft/world/level/block/entity/TheEndGatewayBlockEntity.java
index 74fff57ac1ab7d35cd12ec7aeefa2cd4c43065ba..0fdf7647070c2e8c9ce8a41c7d3e1e38f6b2e4c9 100644
--- a/net/minecraft/world/level/block/entity/TheEndGatewayBlockEntity.java
+++ b/net/minecraft/world/level/block/entity/TheEndGatewayBlockEntity.java
@@ -245,7 +245,7 @@ public class TheEndGatewayBlockEntity extends TheEndPortalBlockEntity {
     }
 
     private static void spawnGatewayPortal(ServerLevel level, BlockPos pos, EndGatewayConfiguration config) {
-        Feature.END_GATEWAY.place(config, level, level.getChunkSource().getGenerator(), RandomSource.create(), pos);
+        Feature.END_GATEWAY.place(config, level, level.getChunkSource().getGenerator(), level.random, pos); // Gale - Patina - reduce RandomSource instances
     }
 
     @Override
diff --git a/net/minecraft/world/level/dimension/end/EndDragonFight.java b/net/minecraft/world/level/dimension/end/EndDragonFight.java
index 04b03940a8c7d0d1e04298d7bcbe245a4174f7d8..81b13c40a80f513dc4f20a344c001a3c9864c84d 100644
--- a/net/minecraft/world/level/dimension/end/EndDragonFight.java
+++ b/net/minecraft/world/level/dimension/end/EndDragonFight.java
@@ -429,7 +429,7 @@ public class EndDragonFight {
             .registryAccess()
             .lookup(Registries.CONFIGURED_FEATURE)
             .flatMap(registry -> registry.get(EndFeatures.END_GATEWAY_DELAYED))
-            .ifPresent(endGatewayFeature -> endGatewayFeature.value().place(this.level, this.level.getChunkSource().getGenerator(), RandomSource.create(), pos));
+            .ifPresent(endGatewayFeature -> endGatewayFeature.value().place(this.level, this.level.getChunkSource().getGenerator(), this.level.random, pos)); // Gale - Patina - reduce RandomSource instances
     }
 
     public void spawnExitPortal(boolean active) {
@@ -450,7 +450,7 @@ public class EndDragonFight {
         }
         // Paper end - Prevent "softlocked" exit portal generation
         if (endPodiumFeature.place(
-            FeatureConfiguration.NONE, this.level, this.level.getChunkSource().getGenerator(), RandomSource.create(), this.portalLocation
+            FeatureConfiguration.NONE, this.level, this.level.getChunkSource().getGenerator(), this.level.random, this.portalLocation // Gale - Patina - reduce RandomSource instances
         )) {
             int i = Mth.positiveCeilDiv(4, 16);
             this.level.getChunkSource().chunkMap.waitForLightBeforeSending(new ChunkPos(this.portalLocation), i);
