From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Dreeam <61569423+Dreeam-qwq@users.noreply.github.com>
Date: Fri, 23 Aug 2024 22:04:20 -0400
Subject: [PATCH] Nitori: Async playerdata saving

Original license: GPL-3.0
Original project: https://github.com/Gensokyo-Reimagined/Nitori

diff --git a/net/minecraft/server/PlayerAdvancements.java b/net/minecraft/server/PlayerAdvancements.java
index 78135cf45c8900eb142933d216744f4a73127965..14e33218bb9bd3e1f8484c88114900297ec65c1e 100644
--- a/net/minecraft/server/PlayerAdvancements.java
+++ b/net/minecraft/server/PlayerAdvancements.java
@@ -111,6 +111,7 @@ public class PlayerAdvancements {
 
     private void load(ServerAdvancementManager manager) {
         if (Files.isRegularFile(this.playerSavePath)) {
+            org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(playerSavePath, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.advancements); // Leaf - Async playerdata saving
             try (Reader bufferedReader = Files.newBufferedReader(this.playerSavePath, StandardCharsets.UTF_8)) {
                 JsonElement jsonElement = StrictJsonParser.parse(bufferedReader);
                 PlayerAdvancements.Data data = this.codec.parse(JsonOps.INSTANCE, jsonElement).getOrThrow(JsonParseException::new);
@@ -128,17 +129,18 @@ public class PlayerAdvancements {
 
     public void save() {
         if (org.spigotmc.SpigotConfig.disableAdvancementSaving) return; // Spigot
+        // Leaf start - Async playerdata saving
         JsonElement jsonElement = this.codec.encodeStart(JsonOps.INSTANCE, this.asData()).getOrThrow();
-
-        try {
-            FileUtil.createDirectoriesSafe(this.playerSavePath.getParent());
-
-            try (Writer bufferedWriter = Files.newBufferedWriter(this.playerSavePath, StandardCharsets.UTF_8)) {
-                GSON.toJson(jsonElement, GSON.newJsonWriter(bufferedWriter));
-            }
-        } catch (JsonIOException | IOException var7) {
-            LOGGER.error("Couldn't save player advancements to {}", this.playerSavePath, var7);
-        }
+        Path path = this.playerSavePath;
+        org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(() -> {
+            FileUtil.createDirectoriesSafe(path.getParent());
+            String content = GSON.toJson(jsonElement);
+            Path temp = org.dreeam.leaf.async.AsyncPlayerDataSaving.tempFile(path);
+            org.apache.commons.io.FileUtils.writeStringToFile(temp.toFile(), content, java.nio.charset.StandardCharsets.UTF_8, false);
+            Files.move(temp, path, java.nio.file.StandardCopyOption.REPLACE_EXISTING);
+            return null;
+        }, this.playerSavePath, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.advancements);
+        // Leaf end - Async playerdata saving
     }
 
     private void applyFrom(ServerAdvancementManager advancementManager, PlayerAdvancements.Data data) {
diff --git a/net/minecraft/stats/ServerStatsCounter.java b/net/minecraft/stats/ServerStatsCounter.java
index f239f445f83d50a69e7e6ffb97e7cf005c421e3a..13710f2fcceba200b6df8222d2402f33f83be0da 100644
--- a/net/minecraft/stats/ServerStatsCounter.java
+++ b/net/minecraft/stats/ServerStatsCounter.java
@@ -68,6 +68,7 @@ public class ServerStatsCounter extends StatsCounter {
         if (Files.isRegularFile(file)) {
             try (Reader bufferedReader = Files.newBufferedReader(file, StandardCharsets.UTF_8)) {
                 JsonElement jsonElement = StrictJsonParser.parse(bufferedReader);
+                org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(file, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.stats); // Leaf - Async playerdata saving
                 this.parse(server.getFixerUpper(), jsonElement);
             } catch (IOException var8) {
                 LOGGER.error("Couldn't read statistics file {}", file, var8);
@@ -90,15 +91,16 @@ public class ServerStatsCounter extends StatsCounter {
 
     public void save() {
         if (org.spigotmc.SpigotConfig.disableStatSaving) return; // Spigot
-        try {
-            FileUtil.createDirectoriesSafe(this.file.getParent());
-
-            try (Writer bufferedWriter = Files.newBufferedWriter(this.file, StandardCharsets.UTF_8)) {
-                GSON.toJson(this.toJson(), GSON.newJsonWriter(bufferedWriter));
-            }
-        } catch (JsonIOException | IOException var6) {
-            LOGGER.error("Couldn't save stats to {}", this.file, var6);
-        }
+        // Leaf start - Async playerdata saving
+        Path file = this.file;
+        JsonElement data = this.toJson();
+        org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(() -> {
+            java.nio.file.Path temp = org.dreeam.leaf.async.AsyncPlayerDataSaving.tempFile(file);
+            org.apache.commons.io.FileUtils.writeStringToFile(temp.toFile(), GSON.toJson(data), java.nio.charset.StandardCharsets.UTF_8, false);
+            java.nio.file.Files.move(temp, file, java.nio.file.StandardCopyOption.REPLACE_EXISTING);
+            return null;
+        }, file, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.stats);
+        // Leaf end - Async playerdata saving
     }
 
     @Override
diff --git a/net/minecraft/world/level/storage/LevelStorageSource.java b/net/minecraft/world/level/storage/LevelStorageSource.java
index 140630186c3b0324c248cc2a2f31d3b906557b9c..75feaa87159f8bf399b6d51f73ccf1c25a50265e 100644
--- a/net/minecraft/world/level/storage/LevelStorageSource.java
+++ b/net/minecraft/world/level/storage/LevelStorageSource.java
@@ -516,15 +516,20 @@ public class LevelStorageSource {
         private void saveLevelData(CompoundTag tag) {
             Path path = this.levelDirectory.path();
 
-            try {
+            // Leaf start - Async playerdata saving
+            // Save level.dat asynchronously
+
+            Path path2 = this.levelDirectory.oldDataFile();
+            Path path3 = this.levelDirectory.dataFile();
+            org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(() -> {
+                var nbtBytes = new it.unimi.dsi.fastutil.io.FastByteArrayOutputStream(65536);
+                NbtIo.writeCompressed(tag, nbtBytes);
                 Path path1 = Files.createTempFile(path, "level", ".dat");
-                NbtIo.writeCompressed(tag, path1);
-                Path path2 = this.levelDirectory.oldDataFile();
-                Path path3 = this.levelDirectory.dataFile();
+                org.apache.commons.io.FileUtils.writeByteArrayToFile(path1.toFile(), nbtBytes.array, 0, nbtBytes.length, false);
                 Util.safeReplaceFile(path3, path1, path2);
-            } catch (Exception var6) {
-                LevelStorageSource.LOGGER.error("Failed to save level {}", path, var6);
-            }
+                return null;
+            }, path3, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.levelData);
+            // Leaf end - Async playerdata saving
         }
 
         public Optional<Path> getIconFile() {
diff --git a/net/minecraft/world/level/storage/PlayerDataStorage.java b/net/minecraft/world/level/storage/PlayerDataStorage.java
index b8ef50bc3d07890c9da2c98d5f009a3adc52f4b0..11055fa067933083af5fca1c9d9e45435684f23b 100644
--- a/net/minecraft/world/level/storage/PlayerDataStorage.java
+++ b/net/minecraft/world/level/storage/PlayerDataStorage.java
@@ -38,15 +38,28 @@ public class PlayerDataStorage {
             Path path = this.playerDir.toPath();
             Path path1 = Files.createTempFile(path, player.getStringUUID() + "-", ".dat");
             CompoundTag compoundTag = tagValueOutput.buildResult();
-            NbtIo.writeCompressed(compoundTag, path1);
-            Path path2 = path.resolve(player.getStringUUID() + ".dat");
-            Path path3 = path.resolve(player.getStringUUID() + ".dat_old");
-            Util.safeReplaceFile(path2, path1, path3);
+            save(player.getStringUUID(), compoundTag);
         } catch (Exception var11) {
             LOGGER.warn("Failed to save player data for {}", player.getPlainTextName(), var11); // Paper - Print exception
         }
     }
 
+    // Leaf start - Async playerdata saving
+    public void save(String stringId, CompoundTag compoundTag) {
+        Path path = this.playerDir.toPath();
+        Path path2 = path.resolve(stringId + ".dat");
+        org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(() -> {
+            var nbtBytes = new it.unimi.dsi.fastutil.io.FastByteArrayOutputStream(65536);
+            NbtIo.writeCompressed(compoundTag, nbtBytes);
+            Path path1 = org.dreeam.leaf.async.AsyncPlayerDataSaving.tempFile(path, stringId, ".dat");
+            org.apache.commons.io.FileUtils.writeByteArrayToFile(path1.toFile(), nbtBytes.array, 0, nbtBytes.length, false);
+            Path path3 = path.resolve(stringId + ".dat_old");
+            Util.safeReplaceFile(path2, path1, path3);
+            return null;
+        }, path2, org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.playerdata);
+    }
+    // Leaf end - Async playerdata saving
+
     private void backup(NameAndId nameAndId, String suffix) {
         Path path = this.playerDir.toPath();
         String string = nameAndId.id().toString();
@@ -76,6 +89,7 @@ public class PlayerDataStorage {
         if (file.exists() && file.isFile()) {
             try {
                 // Spigot start
+                org.dreeam.leaf.async.AsyncPlayerDataSaving.submit(file.toPath(), org.dreeam.leaf.config.modules.async.AsyncPlayerDataSave.playerdata); // Leaf - Async playerdata saving
                 Optional<CompoundTag> optional = Optional.of(NbtIo.readCompressed(file.toPath(), NbtAccounter.unlimitedHeap()));
                 if (usingWrongFile) {
                     file.renameTo(new File(file.getPath() + ".offline-read"));
