From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Martijn Muijsers <martijnmuijsers@live.nl>
Date: Wed, 30 Aug 2023 20:17:20 +0200
Subject: [PATCH] Reduce skull ItemStack lookups for reduced visibility

License: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)
Gale - https://galemc.org

This patch is based on the following patch:
"feat: reduce sensor work"
By: peaches94 <peachescu94@gmail.com>
As part of: Petal (https://github.com/Bloom-host/Petal)
Licensed under: GPL-3.0 (https://www.gnu.org/licenses/gpl-3.0.html)

* Petal description *

this patch is focused around the sensors used for ai
delete the line of sight cache less often and use a faster nearby comparison

diff --git a/net/minecraft/world/entity/LivingEntity.java b/net/minecraft/world/entity/LivingEntity.java
index dd267e4779a34cdb44c2aedc8c6de697e69fc4ad..9905d329bb3caf85e1e123ce91c830596649f9be 100644
--- a/net/minecraft/world/entity/LivingEntity.java
+++ b/net/minecraft/world/entity/LivingEntity.java
@@ -1062,22 +1062,23 @@ public abstract class LivingEntity extends Entity implements Attackable, Waypoin
         }
 
         if (lookingEntity != null) {
-            ItemStack itemBySlot = this.getItemBySlot(EquipmentSlot.HEAD);
+            // Gale start - Petal - reduce skull ItemStack lookups for reduced visibility
             EntityType<?> type = lookingEntity.getType();
             // Purpur start - Mob head visibility percent
-            if (type == EntityType.SKELETON && itemBySlot.is(Items.SKELETON_SKULL)) {
+            if (type == EntityType.SKELETON && this.getItemBySlot(EquipmentSlot.HEAD).is(Items.SKELETON_SKULL)) {
                 d *= lookingEntity.level().purpurConfig.skeletonHeadVisibilityPercent;
             }
-            else if (type == EntityType.ZOMBIE && itemBySlot.is(Items.ZOMBIE_HEAD)) {
+            else if (type == EntityType.ZOMBIE && this.getItemBySlot(EquipmentSlot.HEAD).is(Items.ZOMBIE_HEAD)) {
                 d *= lookingEntity.level().purpurConfig.zombieHeadVisibilityPercent;
             }
-            else if ((type == EntityType.PIGLIN || type == EntityType.PIGLIN_BRUTE) && itemBySlot.is(Items.PIGLIN_HEAD)) {
+            else if ((type == EntityType.PIGLIN || type == EntityType.PIGLIN_BRUTE) && this.getItemBySlot(EquipmentSlot.HEAD).is(Items.PIGLIN_HEAD)) {
                 d *= lookingEntity.level().purpurConfig.piglinHeadVisibilityPercent;
             }
-            else if (type == EntityType.CREEPER && itemBySlot.is(Items.CREEPER_HEAD)) {
+            else if (type == EntityType.CREEPER && this.getItemBySlot(EquipmentSlot.HEAD).is(Items.CREEPER_HEAD)) {
                 d *= lookingEntity.level().purpurConfig.creeperHeadVisibilityPercent;
             }
             // Purpur end - Mob head visibility percent
+            // Gale end - Petal - reduce skull ItemStack lookups for reduced visibility
         }
 
         // Purpur start - Configurable mob blindness
