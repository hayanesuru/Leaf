From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hayanesuru <hayanesuru@outlook.jp>
Date: Sat, 9 Aug 2025 15:39:09 +0900
Subject: [PATCH] Pluto: don't load chunks to spread grass

Original license: GPL-3.0
Original project: https://github.com/Yive/Pluto

diff --git a/net/minecraft/world/level/block/SpreadingSnowyDirtBlock.java b/net/minecraft/world/level/block/SpreadingSnowyDirtBlock.java
index b11c6d76cb9df1f92a4581646929d0dc79ec3e4a..7b3f3b6d975cc3ac21596fbe4a77e0151c524504 100644
--- a/net/minecraft/world/level/block/SpreadingSnowyDirtBlock.java
+++ b/net/minecraft/world/level/block/SpreadingSnowyDirtBlock.java
@@ -52,7 +52,7 @@ public abstract class SpreadingSnowyDirtBlock extends SnowyDirtBlock {
     protected void randomTick(BlockState state, ServerLevel level, BlockPos pos, RandomSource random) {
         if (this instanceof GrassBlock && level.paperConfig().tickRates.grassSpread != 1 && (level.paperConfig().tickRates.grassSpread < 1 || (net.minecraft.server.MinecraftServer.currentTick + pos.hashCode()) % level.paperConfig().tickRates.grassSpread != 0)) { return; } // Paper - Configurable random tick rates for blocks
         // Paper start - Perf: optimize dirt and snow spreading
-        final net.minecraft.world.level.chunk.ChunkAccess cachedBlockChunk = level.getChunkIfLoaded(pos);
+        final net.minecraft.world.level.chunk.LevelChunk cachedBlockChunk = level.getChunkAtIfLoadedUnchecked(pos.getX() >> 4, pos.getZ() >> 4); // Leaf - optimize get chunk
         if (cachedBlockChunk == null) { // Is this needed?
             return;
         }
@@ -71,21 +71,29 @@ public abstract class SpreadingSnowyDirtBlock extends SnowyDirtBlock {
 
                 for (int i = 0; i < 4; i++) {
                     BlockPos blockPos = pos.offset(random.nextInt(3) - 1, random.nextInt(5) - 3, random.nextInt(3) - 1);
+                    // Pluto start - don't load chunks to spread grass
                     // Paper start - Perf: optimize dirt and snow spreading
                     if (pos.getX() == blockPos.getX() && pos.getY() == blockPos.getY() && pos.getZ() == blockPos.getZ()) {
                         continue;
                     }
 
-                    final net.minecraft.world.level.chunk.ChunkAccess access;
-                    if (cachedBlockChunk.locX == blockPos.getX() >> 4 && cachedBlockChunk.locZ == blockPos.getZ() >> 4) {
+                    int x = blockPos.getX();
+                    int y = blockPos.getY();
+                    int z = blockPos.getZ();
+                    final net.minecraft.world.level.chunk.LevelChunk access;
+                    if (cachedBlockChunk.locX == x >> 4 && cachedBlockChunk.locZ == z >> 4) {
                         access = cachedBlockChunk;
                     } else {
-                        access = level.getChunkAt(blockPos);
+                        access = level.getChunkAtIfLoadedUnchecked(x >> 4, z >> 4);
+                        if (access == null) {
+                            continue;
+                        }
                     }
-                    if (access.getBlockState(blockPos).is(Blocks.DIRT) && SpreadingSnowyDirtBlock.canPropagate(access, blockState, level, blockPos)) {
-                        org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, pos, blockPos, blockState.setValue(SNOWY, isSnowySetting(access.getBlockState(blockPos.above()))), Block.UPDATE_ALL); // CraftBukkit
+                    if (access.getBlockStateFinal(x, y, z).is(Blocks.DIRT) && SpreadingSnowyDirtBlock.canPropagate(access, blockState, level, blockPos)) {
+                        org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockSpreadEvent(level, pos, blockPos, blockState.setValue(SNOWY, isSnowySetting(access.getBlockStateFinal(x, y + 1, z))), Block.UPDATE_ALL); // CraftBukkit
                         // Paper end - Perf: optimize dirt and snow spreading
                     }
+                    // Pluto end - don't load chunks to spread grass
                 }
             }
         }
