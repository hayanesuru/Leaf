From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hayanesuru <hayanesuru@outlook.jp>
Date: Sat, 9 Aug 2025 15:12:14 +0900
Subject: [PATCH] counting chunk section fluid


diff --git a/net/minecraft/world/level/Level.java b/net/minecraft/world/level/Level.java
index a0a2b6b32b0ea1a4199adf540b887b1028cb8c1e..7326a0a0fbeb4f8c9e7bd6f3946bb4beaa09a3a6 100644
--- a/net/minecraft/world/level/Level.java
+++ b/net/minecraft/world/level/Level.java
@@ -1399,6 +1399,14 @@ public abstract class Level implements LevelAccessor, AutoCloseable, ca.spottedl
         }
     }
 
+    // Leaf start - counting chunk section fluid
+    @Nullable
+    public final FluidState getFluidStateIfLoadedUnchecked(final int x, final int y, final int z) {
+        LevelChunk chunkAt = ((ServerLevel) this).chunkSource.fullChunksNonSync.get(ca.spottedleaf.moonrise.common.util.CoordinateUtils.getChunkKey(x >> 4, z >> 4));
+        return chunkAt == null ? null : chunkAt.getFluidStateFinal(x, y, z);
+    }
+    // Leaf end - counting chunk section fluid
+
     public boolean isBrightOutside() {
         return !this.dimensionType().hasFixedTime() && this.skyDarken < 4;
     }
diff --git a/net/minecraft/world/level/chunk/LevelChunk.java b/net/minecraft/world/level/chunk/LevelChunk.java
index 672656e9a5079c3050dee9efffd9db0b8a303ec9..e96a9872152fc3276fedda14f6bc61eafbafca0f 100644
--- a/net/minecraft/world/level/chunk/LevelChunk.java
+++ b/net/minecraft/world/level/chunk/LevelChunk.java
@@ -338,6 +338,21 @@ public class LevelChunk extends ChunkAccess implements DebugValueSource, ca.spot
         // Leaf end - optimize LevelChunk#getBlockStateFinal
     }
 
+    // Leaf start - counting chunk section fluid
+    public FluidState getFluidStateFinal(final int x, final int y, final int z) {
+        final int sectionIndex = (y >> 4) - this.minSection;
+        if (sectionIndex < 0 || sectionIndex >= this.sections.length) {
+            return AIR_FLUIDSTATE;
+        } else {
+            LevelChunkSection section = this.sections[sectionIndex];
+            if (section.waterFluidCount == 0 && section.lavaFluidCount == 0) {
+                return AIR_FLUIDSTATE;
+            }
+            return section.states.get((y & 15) << 8 | (z & 15) << 4 | x & 15).getFluidState();
+        }
+    }
+    // Leaf end - counting chunk section fluid
+
     @Override
     public BlockState getBlockState(BlockPos pos) {
         if (true) {
diff --git a/net/minecraft/world/level/chunk/LevelChunkSection.java b/net/minecraft/world/level/chunk/LevelChunkSection.java
index 201ba8b6ea45f526fbd5292164bb4cb6c066d9a8..7442f168e4c0dc0f19e4a7efaaca474358a501b1 100644
--- a/net/minecraft/world/level/chunk/LevelChunkSection.java
+++ b/net/minecraft/world/level/chunk/LevelChunkSection.java
@@ -17,6 +17,8 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
     short nonEmptyBlockCount; // Paper - package private
     private short tickingBlockCount;
     private short tickingFluidCount;
+    public short waterFluidCount; // Leaf - counting chunk section fluid
+    public short lavaFluidCount; // Leaf - counting chunk section fluid
     public final PalettedContainer<BlockState> states;
     private PalettedContainer<Holder<Biome>> biomes; // CraftBukkit - read/write
 
@@ -48,6 +50,8 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
         this.nonEmptyBlockCount = section.nonEmptyBlockCount;
         this.tickingBlockCount = section.tickingBlockCount;
         this.tickingFluidCount = section.tickingFluidCount;
+        this.waterFluidCount = section.waterFluidCount; // Leaf - counting chunk section fluid
+        this.lavaFluidCount = section.lavaFluidCount; // Leaf - counting chunk section fluid
         this.states = section.states.copy();
         this.biomes = section.biomes.copy();
     }
@@ -143,6 +147,15 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
             if (blockState.isRandomlyTicking()) {
                 this.tickingBlockCount--;
             }
+            // Leaf start - counting chunk section fluid
+            final int flags = blockState.tagFlag;
+            if ((flags & org.dreeam.leaf.util.BlockMasks.WATER) != 0) {
+                this.waterFluidCount--;
+            }
+            if ((flags & org.dreeam.leaf.util.BlockMasks.LAVA) != 0) {
+                this.lavaFluidCount--;
+            }
+            // Leaf end - counting chunk section fluid
         }
 
         if (!!fluidState.isRandomlyTicking()) { // Paper - block counting
@@ -154,6 +167,15 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
             if (state.isRandomlyTicking()) {
                 this.tickingBlockCount++;
             }
+            // Leaf start - counting chunk section fluid
+            final int flags = state.tagFlag;
+            if ((flags & org.dreeam.leaf.util.BlockMasks.WATER) != 0) {
+                this.waterFluidCount++;
+            }
+            if ((flags & org.dreeam.leaf.util.BlockMasks.LAVA) != 0) {
+                this.lavaFluidCount++;
+            }
+            // Leaf end - counting chunk section fluid
         }
 
         if (!!fluidState1.isRandomlyTicking()) { // Paper - block counting
@@ -187,6 +209,8 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
         this.nonEmptyBlockCount = (short)0;
         this.tickingBlockCount = (short)0;
         this.tickingFluidCount = (short)0;
+        this.waterFluidCount = (short)0; // Leaf - counting chunk section fluid
+        this.lavaFluidCount = (short)0; // Leaf - counting chunk section fluid
         this.specialCollidingBlocks = (short)0;
         this.tickingBlocks.clear();
 
@@ -234,6 +258,15 @@ public class LevelChunkSection implements ca.spottedleaf.moonrise.patches.block_
                         tickingBlocks.add(raw[i]);
                     }
                 }
+                // Leaf start - counting chunk section fluid
+                final int flags = state.tagFlag;
+                if ((flags & org.dreeam.leaf.util.BlockMasks.WATER) != 0) {
+                    this.waterFluidCount += (short)paletteCount;
+                }
+                if ((flags & org.dreeam.leaf.util.BlockMasks.LAVA) != 0) {
+                    this.lavaFluidCount += (short)paletteCount;
+                }
+                // Leaf end - counting chunk section fluid
 
                 final FluidState fluid = state.getFluidState();
 
