From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hayanesuru <hayanesuru@outlook.jp>
Date: Sat, 9 Aug 2025 15:43:17 +0900
Subject: [PATCH] optimize getOnPos


diff --git a/net/minecraft/world/entity/Entity.java b/net/minecraft/world/entity/Entity.java
index 614627f6319936b684dcd008e6714c1b97d36232..bd1b5ec838aa04c482d4bf186dd92214dadce4f0 100644
--- a/net/minecraft/world/entity/Entity.java
+++ b/net/minecraft/world/entity/Entity.java
@@ -1493,24 +1493,29 @@ public abstract class Entity implements SyncedDataHolder, DebugValueSource, Name
     }
 
     protected BlockPos getOnPos(float yOffset) {
-        if (this.mainSupportingBlockPos.isPresent() && this.level().getChunkIfLoadedImmediately(this.mainSupportingBlockPos.get()) != null) { // Paper - ensure no loads
+        // Leaf start - optimize getOnPos
+        if (this.mainSupportingBlockPos.isPresent() /*&& this.level().getChunkIfLoadedImmediately(this.mainSupportingBlockPos.get()) != null*/) { // Paper - ensure no loads
             BlockPos blockPos = this.mainSupportingBlockPos.get();
-            if (!(yOffset > 1.0E-5F)) {
-                return blockPos;
-            } else {
-                BlockState blockState = this.level().getBlockState(blockPos);
-                return (!(yOffset <= 0.5) || !blockState.is(BlockTags.FENCES))
-                        && !blockState.is(BlockTags.WALLS)
-                        && !(blockState.getBlock() instanceof FenceGateBlock)
-                    ? blockPos.atY(Mth.floor(this.position.y - yOffset))
-                    : blockPos;
+            net.minecraft.world.level.chunk.LevelChunk chunk = this.level().getChunkIfLoaded(blockPos);
+            if (chunk != null) {
+                if (!(yOffset > 1.0E-5F)) {
+                    return blockPos;
+                } else {
+                    BlockState blockState = chunk.getBlockStateFinal(blockPos.getX(), blockPos.getY(), blockPos.getZ());
+                    int flags = blockState.tagFlag;
+                    return (!(yOffset <= 0.5) || (flags & org.dreeam.leaf.util.BlockMasks.FENCE_TAG) == 0)
+                        && (flags & org.dreeam.leaf.util.BlockMasks.WALL_TAG) == 0
+                        && (flags & org.dreeam.leaf.util.BlockMasks.FENCE_GATE_CL) == 0
+                        ? blockPos.atY(Mth.floor(this.position.y - yOffset))
+                        : blockPos;
+                }
             }
-        } else {
-            int floor = Mth.floor(this.position.x);
-            int floor1 = Mth.floor(this.position.y - yOffset);
-            int floor2 = Mth.floor(this.position.z);
-            return new BlockPos(floor, floor1, floor2);
         }
+        int floor = Mth.floor(this.position.x);
+        int floor1 = Mth.floor(this.position.y - yOffset);
+        int floor2 = Mth.floor(this.position.z);
+        return new BlockPos(floor, floor1, floor2);
+        // Leaf end - optimize getOnPos
     }
 
     protected float getBlockJumpFactor() {
