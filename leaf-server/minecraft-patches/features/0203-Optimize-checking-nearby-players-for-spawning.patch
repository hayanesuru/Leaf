From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Taiyou06 <kaandindar21@gmail.com>
Date: Sat, 8 Feb 2025 05:32:30 +0100
Subject: [PATCH] Optimize checking nearby players for spawning


diff --git a/net/minecraft/server/level/ChunkMap.java b/net/minecraft/server/level/ChunkMap.java
index ae0a7c9b95f4f2561769e0d661fadbe29a2d6f8b..14b2abc51fa5d2caa56adfaf50784296c5668ae6 100644
--- a/net/minecraft/server/level/ChunkMap.java
+++ b/net/minecraft/server/level/ChunkMap.java
@@ -773,7 +773,7 @@ public class ChunkMap extends ChunkStorage implements ChunkHolder.PlayerProvider
     }
 
     private boolean anyPlayerCloseEnoughForSpawningInternal(ChunkPos chunkPos, boolean reducedRange) {
-        double blockRange; // Paper - use from event
+        //double blockRange; // Paper - use from event // Leaf - Optimize checking nearby players for spawning - move down
         // Spigot end
         // Paper start - chunk tick iteration optimisation
         final ca.spottedleaf.moonrise.common.list.ReferenceList<ServerPlayer> players = ((ca.spottedleaf.moonrise.patches.chunk_system.level.ChunkSystemServerLevel)this.level).moonrise$getNearbyPlayers().getPlayers(
@@ -785,23 +785,35 @@ public class ChunkMap extends ChunkStorage implements ChunkHolder.PlayerProvider
 
         final ServerPlayer[] raw = players.getRawDataUnchecked();
         final int len = players.size();
+        // Leaf start - Optimize checking nearby players for spawning
+        // Precompute chunk center once
+        // inline, copy from SectionPos#sectionToBlockCoord
+        final double centerX = (chunkPos.x << 4) + 8;
+        final double centerZ = (chunkPos.z << 4) + 8;
 
-        Objects.checkFromIndexSize(0, len, raw.length);
         for (int i = 0; i < len; ++i) {
             final ServerPlayer serverPlayer = raw[i];
-            // Paper start - PlayerNaturallySpawnCreaturesEvent
-            com.destroystokyo.paper.event.entity.PlayerNaturallySpawnCreaturesEvent event;
-            blockRange = 16384.0D;
+            if (serverPlayer.isSpectator()) continue; // Skip spectators early
+            final double blockRangeSquared;
             if (reducedRange) {
-                event = serverPlayer.playerNaturallySpawnedEvent;
+                // Handle reduced range from PlayerNaturallySpawnCreaturesEvent
+                // Paper start - PlayerNaturallySpawnCreaturesEvent
+                final com.destroystokyo.paper.event.entity.PlayerNaturallySpawnCreaturesEvent event = serverPlayer.playerNaturallySpawnedEvent;
                 if (event == null || event.isCancelled()) continue;
-                blockRange = (double) ((event.getSpawnRadius() << 4) * (event.getSpawnRadius() << 4));
-            }
-            if (this.playerIsCloseEnoughForSpawning(serverPlayer, chunkPos, blockRange)) {
+                final int spawnRadius = event.getSpawnRadius();
+                blockRangeSquared = (double) (spawnRadius * spawnRadius) * 256.0; // (radius << 4)^2
                 // Paper end - PlayerNaturallySpawnCreaturesEvent
+            } else {
+                blockRangeSquared = 16384.0D; // Default 128^2
+            }
+            // Calculate squared distance using precomputed center
+            final double dx = serverPlayer.getX() - centerX;
+            final double dz = serverPlayer.getZ() - centerZ;
+            if (dx * dx + dz * dz < blockRangeSquared) {
                 return true;
             }
         }
+        // Leaf end - Optimize checking nearby players for spawning
 
         return false;
         // Paper end - chunk tick iteration optimisation
