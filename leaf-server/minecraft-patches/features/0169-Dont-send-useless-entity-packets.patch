From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Sat, 6 Jul 2019 17:00:04 -0500
Subject: [PATCH] Dont send useless entity packets

TODO: Add more reducers

Original license: MIT
Original project: https://github.com/PurpurMC/Purpur

diff --git a/net/minecraft/server/level/ServerEntity.java b/net/minecraft/server/level/ServerEntity.java
index db16e1e66807a3dbbff8200d93734c9b38140e6f..61a9d3012eb7a8bfdd3867606cd1b144f6170de2 100644
--- a/net/minecraft/server/level/ServerEntity.java
+++ b/net/minecraft/server/level/ServerEntity.java
@@ -195,11 +195,12 @@ public class ServerEntity {
                 long l1 = this.positionCodec.encodeY(vec3);
                 long l2 = this.positionCodec.encodeZ(vec3);
                 boolean flag5 = l < -32768L || l > 32767L || l1 < -32768L || l1 > 32767L || l2 < -32768L || l2 > 32767L;
+                boolean onGroundChanged = this.wasOnGround != this.entity.onGround(); // Purpur - Dont send useless entity packets
                 if (this.forceStateResync || this.entity.getRequiresPrecisePosition() // Paper - fix desync when a player is added to the tracker
                     || flag5
                     || this.teleportDelay > 400
                     || this.wasRiding
-                    || this.wasOnGround != this.entity.onGround()) {
+                    || onGroundChanged) { // Purpur - Dont send useless entity packets
                     this.wasOnGround = this.entity.onGround();
                     this.teleportDelay = 0;
                     packet = ClientboundEntityPositionSyncPacket.of(this.entity);
@@ -225,6 +226,8 @@ public class ServerEntity {
                 }
                 // Gale end - Airplane - better checking for useless move packets
 
+                if (org.dreeam.leaf.config.modules.opt.ReduceUselessPackets.reduceUselessEntityMovePackets && !onGroundChanged && isUselessMoveEntityPacket(packet)) packet = null; // Purpur - Dont send useless entity packets
+
                 if (this.entity.hasImpulse || this.trackDelta || this.entity instanceof LivingEntity && ((LivingEntity)this.entity).isFallFlying()) {
                     Vec3 deltaMovement = this.entity.getDeltaMovement();
                     if (deltaMovement != this.lastSentMovement) { // SparklyPaper start - skip distanceToSqr call in ServerEntity#sendChanges if the delta movement hasn't changed
@@ -308,6 +311,21 @@ public class ServerEntity {
         );
     }
 
+    // Purpur start - Dont send useless entity packets
+    private boolean isUselessMoveEntityPacket(@Nullable Packet<?> packet) {
+        if (!(packet instanceof ClientboundMoveEntityPacket moveEntityPacket)) return false;
+        return switch (packet) {
+            case ClientboundMoveEntityPacket.Pos ignored ->
+                moveEntityPacket.getXa() == 0 && moveEntityPacket.getYa() == 0 && moveEntityPacket.getZa() == 0;
+            case ClientboundMoveEntityPacket.PosRot ignored ->
+                moveEntityPacket.getXa() == 0 && moveEntityPacket.getYa() == 0 && moveEntityPacket.getZa() == 0 && moveEntityPacket.getYRot() == 0 && moveEntityPacket.getXRot() == 0;
+            case ClientboundMoveEntityPacket.Rot ignored ->
+                moveEntityPacket.getYRot() == 0 && moveEntityPacket.getXRot() == 0;
+            default -> false;
+        };
+    }
+    // Purpur end - Dont send useless entity packets
+
     private void handleMinecartPosRot(NewMinecartBehavior behavior, byte yRot, byte xRot, boolean dirty) {
         this.sendDirtyEntityData();
         if (behavior.lerpSteps.isEmpty()) {
