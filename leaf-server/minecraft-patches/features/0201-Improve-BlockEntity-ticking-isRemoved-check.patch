From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: kidofcubes <kidofcubes@gmail.com>
Date: Sun, 16 Feb 2025 00:51:24 +0800
Subject: [PATCH] Improve BlockEntity ticking isRemoved check

Uses direct reference for isRemoved check in BlockEntity ticking,
reducing cost caused by nested wrapper calls
Leaf (Before): ~15104ms
Leaf (After): ~628ms (-96%)
This should help for massive hopper chains or hopper matrix.

diff --git a/net/minecraft/world/level/chunk/LevelChunk.java b/net/minecraft/world/level/chunk/LevelChunk.java
index 81904bcbb982d770320304ef237b85203cc016df..16dc8ef43c6f7af9802595d3c898b0e52dcebe7c 100644
--- a/net/minecraft/world/level/chunk/LevelChunk.java
+++ b/net/minecraft/world/level/chunk/LevelChunk.java
@@ -1062,15 +1062,29 @@ public class LevelChunk extends ChunkAccess implements DebugValueSource, ca.spot
     static class RebindableTickingBlockEntityWrapper implements TickingBlockEntity {
         private TickingBlockEntity ticker;
         private BlockPos cachedPos; // Leaf - Cache tile entity position
+        private @Nullable BlockEntity blockEntityReference = null; // Leaf - Improve BlockEntity ticking isRemoved check
 
         RebindableTickingBlockEntityWrapper(TickingBlockEntity ticker) {
             this.ticker = ticker;
             this.cachedPos = this.ticker.getPos(); // Leaf - Cache tile entity position
+            // Leaf start - Improve BlockEntity ticking isRemoved check
+            if (ticker instanceof BoundTickingBlockEntity<?> boundTicker) {
+                blockEntityReference = boundTicker.blockEntity;
+            }
+            // Leaf end - Improve BlockEntity ticking isRemoved check
+
         }
 
         void rebind(TickingBlockEntity ticker) {
             this.ticker = ticker;
             this.cachedPos = this.ticker.getPos(); // Leaf - Cache tile entity position
+            // Leaf start - Improve BlockEntity ticking isRemoved check
+            if (ticker instanceof BoundTickingBlockEntity<?> boundTicker) {
+                blockEntityReference = boundTicker.blockEntity;
+            } else {
+                blockEntityReference = null;
+            }
+            // Leaf end - Improve BlockEntity ticking isRemoved check
         }
 
         @Override
@@ -1080,6 +1094,11 @@ public class LevelChunk extends ChunkAccess implements DebugValueSource, ca.spot
 
         @Override
         public boolean isRemoved() {
+            // Leaf start - Improve BlockEntity ticking isRemoved check
+            if (blockEntityReference != null) {
+                return blockEntityReference.isRemoved();
+            }
+            // Leaf end - Improve BlockEntity ticking isRemoved check
             return this.ticker.isRemoved();
         }
 
