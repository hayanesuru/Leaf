From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: hayanesuru <mc@jvavav.com>
Date: Fri, 28 Mar 2025 21:19:19 +0800
Subject: [PATCH] Async playerdata saving


diff --git a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
index f2d87c12dd19210ce7e2147fada5c10191008632..0cc6b6c597ca8c955b246764de637be4c25bfb40 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftOfflinePlayer.java
@@ -207,7 +207,7 @@ public class CraftOfflinePlayer implements OfflinePlayer, ConfigurationSerializa
     }
 
     private CompoundTag getData() {
-        return this.storage.load(this.profile.getName(), this.profile.getId().toString()).orElse(null);
+        return this.storage.load(this.profile.getName(), this.profile.getId().toString(), this.profile.getId()).orElse(null); // Leaf - Async playerdata saving
     }
 
     private CompoundTag getBukkitData() {
@@ -813,6 +813,17 @@ public class CraftOfflinePlayer implements OfflinePlayer, ConfigurationSerializa
      * @param compoundTag
      */
     private void save(CompoundTag compoundTag) {
+        // Leaf start - Async playerdata saving
+        synchronized (server.console.playerDataStorage) {
+            while (server.console.playerDataStorage.savingQueue.contains(getUniqueId())) {
+                try {
+                    Thread.sleep(1L);
+                } catch (InterruptedException ignored) {
+                }
+            }
+            server.console.playerDataStorage.savingQueue.add(getUniqueId());
+        }
+        // Leaf end - Async playerdata saving
         File playerDir = server.console.playerDataStorage.getPlayerDir();
         try {
             File tempFile = File.createTempFile(this.getUniqueId()+"-", ".dat", playerDir);
@@ -822,6 +833,12 @@ public class CraftOfflinePlayer implements OfflinePlayer, ConfigurationSerializa
             net.minecraft.Util.safeReplaceFile(playerDataFile.toPath(), tempFile.toPath(), playerDataFileOld.toPath());
         } catch (java.io.IOException e) {
             e.printStackTrace();
+        // Leaf start - Async playerdata saving
+        } finally {
+            synchronized (server.console.playerDataStorage) {
+                server.console.playerDataStorage.savingQueue.remove(getUniqueId());
+            }
+        // Leaf end - Async playerdata saving
         }
     }
     // Purpur end - OfflinePlayer API
